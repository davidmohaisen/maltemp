import numpy as np
from sklearn.model_selection import train_test_split
import pickle
import ember

def getFamiliesSamples(pathMalware, MalwareList):
    samples = []
    Families = []
    for d in MalwareList:
        samples.append(pathMalware+d[0])
        Families.append(d[6])

    return samples,Families

pathMalware = "../Data/Win/Malware/"

f = open("../Pickles/Data","rb")
MalwareList = pickle.load(f)
files,fam = getFamiliesSamples(pathMalware, MalwareList)



extractor = ember.features.PEFeatureExtractor(2)

countFiles = 0
data = []
family = []
for file_ind in range(len(files)):
    countFiles += 1
    print(countFiles,len(files))
    try:
        bin = open(files[file_ind], "rb").read()
    except:
        print("file not found",files[file_ind])
        continue
    features = np.array(extractor.feature_vector(bin), dtype=np.float32)
    data.append(features)
    family.append(fam[file_ind])
print("Done")
data = np.asarray(data)
family = np.asarray(family)
print(data.shape)
print(family.shape)
f = open("../Pickles/MalwareRespreading/EmberData","wb")
pickle.dump([data,family],f)
